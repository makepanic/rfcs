<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>0487-custom-model-classes - </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch store.js from local - TODO add CDN when 2.x.x is available on cdnjs -->
        <script src="store.js"></script>

        <!-- Custom JS script -->
        

    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = store.get('mdbook-theme');
            if (theme === null || theme === undefined) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = store.get('mdbook-sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li class="affix"><a href="introduction.html">Introduction</a></li><li><a href="0001-transform-attribute-meta-parameter.html"><strong>1.</strong> 0001-transform-attribute-meta-parameter</a></li><li><a href="0003-block-params.html"><strong>2.</strong> 0003-block-params</a></li><li><a href="0003-cli-ember-doctor.html"><strong>3.</strong> 0003-cli-ember-doctor</a></li><li><a href="0010-engines.html"><strong>4.</strong> 0010-engines</a></li><li><a href="0011-improved-cp-syntax.html"><strong>5.</strong> 0011-improved-cp-syntax</a></li><li><a href="0012-help-json-output.html"><strong>6.</strong> 0012-help-json-output</a></li><li><a href="0015-the-road-to-ember-2-0.html"><strong>7.</strong> 0015-the-road-to-ember-2-0</a></li><li><a href="0020-sri-default.html"><strong>8.</strong> 0020-sri-default</a></li><li><a href="0023-command-line-completion.html"><strong>9.</strong> 0023-command-line-completion</a></li><li><a href="0024-bound-attributes.html"><strong>10.</strong> 0024-bound-attributes</a></li><li><a href="0028-app-import-output-file.html"><strong>11.</strong> 0028-app-import-output-file</a></li><li><a href="0029-addon-black-and-whitelist-for-apps.html"><strong>12.</strong> 0029-addon-black-and-whitelist-for-apps</a></li><li><a href="0045-internet-explorer.html"><strong>13.</strong> 0045-internet-explorer</a></li><li><a href="0046-cli-improved-release-process.html"><strong>14.</strong> 0046-cli-improved-release-process</a></li><li><a href="0046-registry-reform.html"><strong>15.</strong> 0046-registry-reform</a></li><li><a href="0050-cli-production-code-stripping.html"><strong>16.</strong> 0050-cli-production-code-stripping</a></li><li><a href="0050-improved-actions.html"><strong>17.</strong> 0050-improved-actions</a></li><li><a href="0053-helpers.html"><strong>18.</strong> 0053-helpers</a></li><li><a href="0055-anonymous-amd.html"><strong>19.</strong> 0055-anonymous-amd</a></li><li><a href="0056-improved-release-cycle.html"><strong>20.</strong> 0056-improved-release-cycle</a></li><li><a href="0057-ember-data-reference-unification.html"><strong>21.</strong> 0057-ember-data-reference-unification</a></li><li><a href="0058-helper-listing.html"><strong>22.</strong> 0058-helper-listing</a></li><li><a href="0061-ember-data-background-fetch.html"><strong>23.</strong> 0061-ember-data-background-fetch</a></li><li><a href="0064-contextual-component-lookup.html"><strong>24.</strong> 0064-contextual-component-lookup</a></li><li><a href="0065-deprecation-warning-handlers.html"><strong>25.</strong> 0065-deprecation-warning-handlers</a></li><li><a href="0080-serve-file-api.html"><strong>26.</strong> 0080-serve-file-api</a></li><li><a href="0086-firefox-in-ci.html"><strong>27.</strong> 0086-firefox-in-ci</a></li><li><a href="0090-addon-tree-caching.html"><strong>28.</strong> 0090-addon-tree-caching</a></li><li><a href="0091-cli-addon-instrumentation-experimental-hooks.html"><strong>29.</strong> 0091-cli-addon-instrumentation-experimental-hooks</a></li><li><a href="0091-weakmap.html"><strong>30.</strong> 0091-weakmap</a></li><li><a href="0092-blueprint-remove-old-files.html"><strong>31.</strong> 0092-blueprint-remove-old-files</a></li><li><a href="0095-cli-standardise-targets.html"><strong>32.</strong> 0095-cli-standardise-targets</a></li><li><a href="0095-router-service.html"><strong>33.</strong> 0095-router-service</a></li><li><a href="0096-enable-yarn-usage.html"><strong>34.</strong> 0096-enable-yarn-usage</a></li><li><a href="0101-ember-data-friendly-errors.html"><strong>35.</strong> 0101-ember-data-friendly-errors</a></li><li><a href="0105-addons-optionalDependencies.html"><strong>36.</strong> 0105-addons-optionalDependencies</a></li><li><a href="0108-add-custom-transform.html"><strong>37.</strong> 0108-add-custom-transform</a></li><li><a href="0110-packaging.html"><strong>38.</strong> 0110-packaging</a></li><li><a href="0114-add-template-lint-addon.html"><strong>39.</strong> 0114-add-template-lint-addon</a></li><li><a href="0116-qunit-dom.html"><strong>40.</strong> 0116-qunit-dom</a></li><li><a href="0120-cli-guides.html"><strong>41.</strong> 0120-cli-guides</a></li><li><a href="0120-route-serializers.html"><strong>42.</strong> 0120-route-serializers</a></li><li><a href="0121-remove-ember-cli-eslint.html"><strong>43.</strong> 0121-remove-ember-cli-eslint</a></li><li><a href="0136-contains-to-includes.html"><strong>44.</strong> 0136-contains-to-includes</a></li><li><a href="0139-isHtmlSafe.html"><strong>45.</strong> 0139-isHtmlSafe</a></li><li><a href="0143-module-unification.html"><strong>46.</strong> 0143-module-unification</a></li><li><a href="0150-factory-for.html"><strong>47.</strong> 0150-factory-for</a></li><li><a href="0176-javascript-module-api.html"><strong>48.</strong> 0176-javascript-module-api</a></li><li><a href="0178-deprecate-ember-k.html"><strong>49.</strong> 0178-deprecate-ember-k</a></li><li><a href="0181-deprecate-ember-data-initializers.html"><strong>50.</strong> 0181-deprecate-ember-data-initializers</a></li><li><a href="0186-track-unique-history-location-state.html"><strong>51.</strong> 0186-track-unique-history-location-state</a></li><li><a href="0191-deprecate-component-lifecycle-hook-args.html"><strong>52.</strong> 0191-deprecate-component-lifecycle-hook-args</a></li><li><a href="0194-deprecate-custom-event-manager.html"><strong>53.</strong> 0194-deprecate-custom-event-manager</a></li><li><a href="0213-custom-components.html"><strong>54.</strong> 0213-custom-components</a></li><li><a href="0225-ember-engines-mount-params.html"><strong>55.</strong> 0225-ember-engines-mount-params</a></li><li><a href="0226-named-blocks.html"><strong>56.</strong> 0226-named-blocks</a></li><li><a href="0229-deprecate-testing-restricted-resolver.html"><strong>57.</strong> 0229-deprecate-testing-restricted-resolver</a></li><li><a href="0232-simplify-qunit-testing-api.html"><strong>58.</strong> 0232-simplify-qunit-testing-api</a></li><li><a href="0236-deprecation-ember-string.html"><strong>59.</strong> 0236-deprecation-ember-string</a></li><li><a href="0237-deprecation-ember-map.html"><strong>60.</strong> 0237-deprecation-ember-map</a></li><li><a href="0240-es-classes.html"><strong>61.</strong> 0240-es-classes</a></li><li><a href="0252-browser-support-changes.html"><strong>62.</strong> 0252-browser-support-changes</a></li><li><a href="0268-acceptance-testing-refactor.html"><strong>63.</strong> 0268-acceptance-testing-refactor</a></li><li><a href="0272-deprecation-native-function-prototype-extensions.html"><strong>64.</strong> 0272-deprecation-native-function-prototype-extensions</a></li><li><a href="0276-named-args.html"><strong>65.</strong> 0276-named-args</a></li><li><a href="0278-template-only-components.html"><strong>66.</strong> 0278-template-only-components</a></li><li><a href="0280-remove-application-wrapper.html"><strong>67.</strong> 0280-remove-application-wrapper</a></li><li><a href="0281-es5-getters.html"><strong>68.</strong> 0281-es5-getters</a></li><li><a href="0286-block-let-template-helper.html"><strong>69.</strong> 0286-block-let-template-helper</a></li><li><a href="0287-promote-in-element-to-public-api.html"><strong>70.</strong> 0287-promote-in-element-to-public-api</a></li><li><a href="0293-record-data.html"><strong>71.</strong> 0293-record-data</a></li><li><a href="0294-optional-jquery.html"><strong>72.</strong> 0294-optional-jquery</a></li><li><a href="0297-deprecate-ember-logger.html"><strong>73.</strong> 0297-deprecate-ember-logger</a></li><li><a href="0300-rfc-process-update.html"><strong>74.</strong> 0300-rfc-process-update</a></li><li><a href="0308-deprecate-property-lookup-fallback.html"><strong>75.</strong> 0308-deprecate-property-lookup-fallback</a></li><li><a href="0311-angle-bracket-invocation.html"><strong>76.</strong> 0311-angle-bracket-invocation</a></li><li><a href="0318-array-helper.html"><strong>77.</strong> 0318-array-helper</a></li><li><a href="0322-deprecate-copy-copyable.html"><strong>78.</strong> 0322-deprecate-copy-copyable</a></li><li><a href="0324-deprecate-component-isvisible.html"><strong>79.</strong> 0324-deprecate-component-isvisible</a></li><li><a href="0326-ember-data-filter-deprecation.html"><strong>80.</strong> 0326-ember-data-filter-deprecation</a></li><li><a href="0329-deprecated-ember-evented-in-ember-data.html"><strong>81.</strong> 0329-deprecated-ember-evented-in-ember-data</a></li><li><a href="0331-deprecate-globals-resolver.html"><strong>82.</strong> 0331-deprecate-globals-resolver</a></li><li><a href="0332-ember-data-record-links-and-meta.html"><strong>83.</strong> 0332-ember-data-record-links-and-meta</a></li><li><a href="0335-deprecate-send-action.html"><strong>84.</strong> 0335-deprecate-send-action</a></li><li><a href="0337-native-class-constructor-update.html"><strong>85.</strong> 0337-native-class-constructor-update</a></li><li><a href="0340-deprecate-ember-merge.html"><strong>86.</strong> 0340-deprecate-ember-merge</a></li><li><a href="0345-discord.html"><strong>87.</strong> 0345-discord</a></li><li><a href="0364-roadmap-2018.html"><strong>88.</strong> 0364-roadmap-2018</a></li><li><a href="0369-deprecate-computed-clobberability.html"><strong>89.</strong> 0369-deprecate-computed-clobberability</a></li><li><a href="0370-deprecate-computed-volatile.html"><strong>90.</strong> 0370-deprecate-computed-volatile</a></li><li><a href="0372-ember-data-model-factory-for.html"><strong>91.</strong> 0372-ember-data-model-factory-for</a></li><li><a href="0373-Element-Modifier-Managers.html"><strong>92.</strong> 0373-Element-Modifier-Managers</a></li><li><a href="0375-deprecate-computed-property-modifier.html"><strong>93.</strong> 0375-deprecate-computed-property-modifier</a></li><li><a href="0386-remove-jquery.html"><strong>94.</strong> 0386-remove-jquery</a></li><li><a href="0389-dynamic-tag-names.html"><strong>95.</strong> 0389-dynamic-tag-names</a></li><li><a href="0391-router-helpers.html"><strong>96.</strong> 0391-router-helpers</a></li><li><a href="0392-deprecate-component-manager-string-lookup.html"><strong>97.</strong> 0392-deprecate-component-manager-string-lookup</a></li><li><a href="0395-ember-data-packages.html"><strong>98.</strong> 0395-ember-data-packages</a></li><li><a href="0398-RouteInfo-Metadata.html"><strong>99.</strong> 0398-RouteInfo-Metadata</a></li><li><a href="0403-ember-data-identifiers.html"><strong>100.</strong> 0403-ember-data-identifiers</a></li><li><a href="0408-decorators.html"><strong>101.</strong> 0408-decorators</a></li><li><a href="0410-tracked-properties.html"><strong>102.</strong> 0410-tracked-properties</a></li><li><a href="0415-render-element-modifiers.html"><strong>103.</strong> 0415-render-element-modifiers</a></li><li><a href="0416-glimmer-components.html"><strong>104.</strong> 0416-glimmer-components</a></li><li><a href="0418-deprecate-route-render-methods.html"><strong>105.</strong> 0418-deprecate-route-render-methods</a></li><li><a href="0421-deprecate-application-controller-props.html"><strong>106.</strong> 0421-deprecate-application-controller-props</a></li><li><a href="0425-website-redesign.html"><strong>107.</strong> 0425-website-redesign</a></li><li><a href="0431-guides-restructure.html"><strong>108.</strong> 0431-guides-restructure</a></li><li><a href="0432-contextual-helpers.html"><strong>109.</strong> 0432-contextual-helpers</a></li><li><a href="0435-modifier-splattributes.html"><strong>110.</strong> 0435-modifier-splattributes</a></li><li><a href="0440-decorator-support.html"><strong>111.</strong> 0440-decorator-support</a></li><li><a href="0445-deprecate-with.html"><strong>112.</strong> 0445-deprecate-with</a></li><li><a href="0446-contribution-guides.html"><strong>113.</strong> 0446-contribution-guides</a></li><li><a href="0449-deprecate-partials.html"><strong>114.</strong> 0449-deprecate-partials</a></li><li><a href="0451-injection-parameter-normalization.html"><strong>115.</strong> 0451-injection-parameter-normalization</a></li><li><a href="0452-ember-data-medium-term-plan.html"><strong>116.</strong> 0452-ember-data-medium-term-plan</a></li><li><a href="0457-nested-lookups.html"><strong>117.</strong> 0457-nested-lookups</a></li><li><a href="0459-angle-bracket-built-in-components.html"><strong>118.</strong> 0459-angle-bracket-built-in-components</a></li><li><a href="0460-yieldable-named-blocks.html"><strong>119.</strong> 0460-yieldable-named-blocks</a></li><li><a href="0461-ember-data-singleton-record-data.html"><strong>120.</strong> 0461-ember-data-singleton-record-data</a></li><li><a href="0463-record-data-state.html"><strong>121.</strong> 0463-record-data-state</a></li><li><a href="0465-record-data-errors.html"><strong>122.</strong> 0465-record-data-errors</a></li><li><a href="0468-classic-decorator.html"><strong>123.</strong> 0468-classic-decorator</a></li><li><a href="0470-fn-helper.html"><strong>124.</strong> 0470-fn-helper</a></li><li><a href="0471-on-modifier.html"><strong>125.</strong> 0471-on-modifier</a></li><li><a href="0478-tracked-properties-updates.html"><strong>126.</strong> 0478-tracked-properties-updates</a></li><li><a href="0481-component-templates-co-location.html"><strong>127.</strong> 0481-component-templates-co-location</a></li><li><a href="0486-deprecate-mouseenter.html"><strong>128.</strong> 0486-deprecate-mouseenter</a></li><li><a href="0487-custom-model-classes.html" class="active"><strong>129.</strong> 0487-custom-model-classes</a></li><li><a href="0491-deprecate-disconnect-outlet.html"><strong>130.</strong> 0491-deprecate-disconnect-outlet</a></li><li><a href="0494-async-observers.html"><strong>131.</strong> 0494-async-observers</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page" tabindex="-1">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html">
                            <i id="print-button" class="fa fa-print" title="Print this book"></i>
                        </a>
                    </div>
                </div>

                <div id="content" class="content">
                    <ul>
<li>Start Date: 2019-05-09</li>
<li>Relevant Team(s): data</li>
<li>RFC PR: <a href="https://github.com/emberjs/rfcs/pull/487">PR</a></li>
<li>Tracking: <a href="https://github.com/emberjs/rfc-tracking/issues/53">Tracking</a></li>
</ul>
<a class="header" href="0487-custom-model-classes.html#custom-model-class-rfc" id="custom-model-class-rfc"><h1>Custom Model Class RFC</h1></a>
<a class="header" href="0487-custom-model-classes.html#summary" id="summary"><h2>Summary</h2></a>
<p>This RFC is a follow-up RFC for #293 RecordData and replaces <a href="https://github.com/runspired/rfcs/blob/ember-data-custom-records/text/0000-ember-data-model-factory-for.md#ember-data--modelfactoryfor">https://github.com/runspired/rfcs/blob/ember-data-custom-records/text/0000-ember-data-model-factory-for.md#ember-data--modelfactoryfor</a></p>
<p>Create a way for addons and user to define their own implementation of a model class. Adds an <code>instantiateRecord</code> method to <code>Store</code> which would allow addons and ED itself to offer a clean replacement the default DS.Model with a custom Model class.</p>
<a class="header" href="0487-custom-model-classes.html#motivation" id="motivation"><h2>Motivation</h2></a>
<ul>
<li>Allowing Addons to experiment with replacing the default DS.Model implementation (<a href="https://github.com/runspired/rfcs/blob/ember-data-custom-records/text/0000-ember-data-model-factory-for.md#ember-data--modelfactoryfor">https://github.com/runspired/rfcs/blob/ember-data-custom-records/text/0000-ember-data-model-factory-for.md#ember-data--modelfactoryfor</a>)</li>
<li>Currently Ember Data conflates schema information and record implementation together as part of properties defined on <code>DS.Model</code>.
DS.Model both defines the schema, that is the attributes and relationships present on a type, and the model implementation, that is the
actual class which is exposed to the app containing those properties. This has several disadvantages:</li>
<li>it makes it hard to optimize the schema information, and ties to a definition of a JS class</li>
<li>it makes it hard to statically analyze the schema</li>
<li>it requires a 1-1 correspondence between the number of backing types in the system and the number of model classes, resulting
in an app sometimes having to ship a much higher number of models than it otherwise would have.</li>
</ul>
<p>This RFC represents the first step in separating the record implementation from schema information.</p>
<a class="header" href="0487-custom-model-classes.html#detailed-design" id="detailed-design"><h2>Detailed design</h2></a>
<p>After the work in <a href="https://github.com/emberjs/rfcs/pull/465">Record Data Errors RFC</a>,  <a href="https://github.com/emberjs/rfcs/pull/463">Record Data State RFC</a>, and <a href="https://github.com/emberjs/rfcs/pull/466">Request State Service RFC</a> we have enough coverage in public apis that we can implement the entire DS.Model class with just a few changes to Store APIs.</p>
<p>We will need five separate changes:</p>
<ul>
<li>A way to instantiate custom Records and for them to be able to access underlying record data</li>
<li>A way for those records to be notified of changes in Record Data</li>
<li>A way to access schema information from the store and not from the DS.Model static properties</li>
<li>Replacement of a few store methods that take DS.Models</li>
<li>Deprecate passing DS.Model classes to adapter/serializers/exposing them on Snapshots</li>
</ul>
<a class="header" href="0487-custom-model-classes.html#instantiating-and-destroying-custom-records" id="instantiating-and-destroying-custom-records"><h2>Instantiating and destroying custom Records</h2></a>
<p>We need to make the following changes:</p>
<ul>
<li>expose a method on the store for instantiating a record</li>
<li>add a hook to be notified when a record is being destroyed for potential cleanup</li>
<li>a way for the record to get notified when RecordData values change</li>
</ul>
<p>The following interface shows the interface of these methods:</p>
<pre><code class="language-ts">interface RecordDataWrapper { // proxies a subset of RD methods and hides the rest
  getAttr(identifier: RecordIdentifier, key: string)
  isAttrDirty(identifier: RecordIdentifier, key)
    
  changedAttributes(identifier: RecordIdentifier)
  hasChangedAttributes(identifier: RecordIdentifier)
  rollbackAttributes(identifier: RecordIdentifier)
  
  getRelationship(identifier: RecordIdentifier, key: string)
  
  setRecordId(identifier: RecordIdentifier, id: string): void;
  
  getErrors(identifier: RecordIdentifier)
  getMeta(identifier: RecordIdentifier)
  
  isNew(identifier: RecordIdentifier): boolean;
  isDeleted(identifier: RecordIdentifier): boolean;

  setDirtyAttribute(identifier, key: string, value: any): void;

  addToHasMany(key: string, identifiers: Identifier[], idx?: number): void;
  removeFromHasMany(key: string, identifiers: Identifier[]): void;
  setDirtyHasMany(key: string, identifiers: Identifier[]): void;

  setDirtyBelongsTo(name: string, identifier: Identifier | null): void;
}
  
interface RecordDataFor {
  (identifier: RecordIdentifier): RecordDataWrapper
}
    
class Store {
  instantiateRecord(
    identifier: RecordIdentifier, 
    createRecordArgs: { [key: string]: any }, // args passed in to store.createRecord() and processed by recordData to be set on creation
    recordDataFor: RecordDataFor, 
    notificationManager: NotificationManager): unknown
    
  teardownRecord(record): void
}
</code></pre>
<p>Instead of passing the entire RecordData Class to <code>instantiateRecord</code>, we pass in a lookup method that returns a record data wrapper which exposes only the local facing methods and hide the server/adapter facing methods that the Model should not have access to.</p>
<p>We also expose <code>teardownRecord</code>, which will get called whenever a record is getting unloaded, or otherwise disposed of (if we add future ways of destroying records that are uncoupled from unloading) from the identity map, thus giving addons an opportunity to perform cleanup.</p>
<a class="header" href="0487-custom-model-classes.html#change-notification" id="change-notification"><h2>Change Notification</h2></a>
<p>In order for the record class to learn about changes to the underlying data, it will be passed a <code>NotificationManager</code> as a constructor argument, which will allow it to
subscribe and unsubscribe to notifications of underlying changes to the data. Once <code>RecordData</code> calls one of the notification methods, the notification manager will call
any registered callback for the given identifier, and pass in the type of the notification, allowing the record the opportunity to repull the data if needed. There are no guarantees around the timing of the notification callback being called after <code>RecordData</code> informs the store of changes. We expect that in a modern Ember app with tracked properties, this wouldn't be the common path for tracking changes.</p>
<pre><code class="language-ts">function unsubscribe(token: UnsubscribeToken)

interface NotificationCallback {
  (identifier: Identifier, notificationType: 'attributes' | 'relationships' | 'errors'  | 'meta'  | 'unload'): void;
}
    
interface NotificationManager {
  subscribe(identifier, NotificationCallback): UnsubscribeToken
 }
</code></pre>
<a class="header" href="0487-custom-model-classes.html#exposing-schema-information" id="exposing-schema-information"><h2>Exposing schema information</h2></a>
<p>We currently keep schema information on <code>DS.Model</code> class. In order to allow for custom Model implementations we need to allow lookup of schema info from the store. We already have specified a schema api that RecordData consumes: <code>attributesDefinitionFor</code> and <code>relationshipDefinitionFor</code>. We would define on a schema interface that the store would expose and addons could use. <strong>The schema methods are not ergonomic on purpose.</strong> They match the current Record Data apis and are designed as a stepping stone on the way of having a better, user facing schema APIs. Addons could provide their own <code>SchemaDefinitionService</code> by calling <code>registerSchemaDefinitionService</code>. We would initially not allow calling <code>registerSchemaDefinitionService</code> more than once, but this constraint could potentially be relaxed in the future. The schema info is currently primarily geared towards being used by the internal relationship handling layer, the serializer/adapter layers and the DebugAdapter. Schema methods support both static and dynamic schema computation. For static schemas, the method can always respond with a schema definition based on the type passed, and for dynamic changing schemas, it can look up the underlying data by the identifer which is passed in. We would also add a method called <code>doesTypeExist</code>, which would return <code>true</code> if ED knew that a given string is a model type and <code>false</code> otherwise.</p>
<pre><code class="language-ts">export interface RelationshipDefinition {
  kind: 'hasMany'| 'belongsTo';
  type: string;
  options: { [key: string]: any } ;
  name: string;
}
    
interface RelationshipsDefinition {
  [key: string]: RelationshipDefinition
}
    
interface AttributeDefinition {
  name: string;
  options: { [key: string]: any };
  type: string;
}

interface AttributesDefinition {
  [key: string]: AttributeDefinition
}
    
interface SchemaDefinitionService {
  // Following the existing RD implementation 
  attributesDefinitonFor(identifier: RecordIdentifier | type: string): AttributesDefiniton
  
  // Following the existing RD implementation
  relationshipsDefinitionFor(identifier: RecordIdentifier | type: string): RelationshipsDefinition

  doesTypeExist(type: string): boolean
}

class Store {
  registerSchemaDefinitionService(schema: SchemaDefinitionService): void

  getSchemaDefinitionService(): SchemaDefinitionService
}
</code></pre>
<a class="header" href="0487-custom-model-classes.html#adding-store-methods-for-manipulating-records" id="adding-store-methods-for-manipulating-records"><h2>Adding store methods for manipulating records</h2></a>
<p>Currently there exist methods on DS.Model that call into <code>internalModel</code> for it's functionality. In order for a parallel implementation
to be possible, we need to expose that functionality through public methods on the store.</p>
<pre><code class="language-ts">class Store {
  saveRecord(record): Promise // equivalent of currently doing record.save()
  serializeRecord(record): any // equivalent of currently doing record.serialize()
  relationshipReferenceFor(identifier: RecordIdentifier, key: string): RelationshipReference
}
</code></pre>
<p>this would allow you to have a custom model class like this:</p>
<pre><code class="language-ts">class CustomModel {
  save() {
    return this._store.saveRecord(this);
  }
}
</code></pre>
<a class="header" href="0487-custom-model-classes.html#record-arrays" id="record-arrays"><h3>Record Arrays</h3></a>
<p>Currently Ember Data manages live Record Arrays which are returned as a response to query methods such as <code>findAll</code> or <code>queryRecords</code>. Because ED can track records which are returned from <code>instantiateRecord</code>, it will be able to seamlessly manage custom models which are part of Ember Data record arrays and clean them up correctly.</p>
<p>If an addon implements it's own record array like structures, it will be able to manage membership of Ember Data default records by subclassing <code>teardownRecord</code>, which gives it a convinient place to listen for a record being destroyed.</p>
<a class="header" href="0487-custom-model-classes.html#deprecating-dsmodel-being-passed-to-serializers-and-adapters-and-storemodelfor" id="deprecating-dsmodel-being-passed-to-serializers-and-adapters-and-storemodelfor"><h2>Deprecating DS.Model being passed to serializers and adapters and store.modelFor</h2></a>
<p>Currently some adapter/serializer methods get the underlying class passed in. For example:</p>
<pre><code class="language-ts">// Adapter
createRecord(store, type, snapshot)
findRecord(store, type, id, snapshot)

// Serializer
normalizeResponse(store, primaryModelClass, payload, id, requestType)

// Store
modelFor(modelName)
</code></pre>
<a class="header" href="0487-custom-model-classes.html#serializing" id="serializing"><h3>Serializing</h3></a>
<p>When serializing we already have a <code>Snapshot</code> passed in as an argument which has all of the information that a <code>ModelClass</code> provides. We would deprecate the class argument being passed in, and instruct the user to refactor towards using the <code>Snapshot</code>.</p>
<p>For example:</p>
<pre><code class="language-ts">createRecord(store, type, snapshot) {
  let url = `/api/${type.modelName}`;
}
</code></pre>
<p>would become</p>
<pre><code class="language-ts">createRecord(store, type, snapshot) {
  let url = `/api/${snapshot.modelName}`;
}
</code></pre>
<p>For backwards compatibility, we would still lookup the class from the registry, and if we found a class we would return it but would no longer error if null was returned. If we did not find the class, we would create a shim class that exposed a deprecated <code>modelName</code>. We would deprecate accessing the properties on the class when passed to serializer/adapter by wrapping it in a proxy in dev mode. Currently Snapshots contain all of the data that is available on the Model class which would be needed for serializing/normalizing.</p>
<a class="header" href="0487-custom-model-classes.html#normalizing" id="normalizing"><h3>Normalizing</h3></a>
<p>While <code>Snapshot</code> roughly corresponds to a <code>Request</code> like object to be used while serializing, and we intend to in the future refactor it to be a request object, we don't have a similar construct when normalizing. In the future, normalizing will have a corresponding <code>Response</code> like object exposed, but for the time being we can still deprecate using the <code>primaryModelClass</code> argument for anything other than <code>modelName</code>, <code>eachAttribute</code>, <code>eachRelationship</code>. If a user accesses any other property on the <code>primaryModelClass</code> they will receive a deprecation.</p>
<p>If there was a custom model instance provided, and we had no corresponding class to pass in to <code>normalizeResponse</code> we would pass in a shim class that only exposed the <code>modelName</code> property, and <code>eachAttribute</code> and <code>eachRelationship</code> methods which would proxy to the underlying schema methods, thus allowing the normalization layers to continue working with custom model classes.</p>
<pre><code class="language-ts">interface ClassSchemaShim {
  modelName: string;
  eachAttribute( (name: string, attr: AttributeDefinition): void ): void;
  eachRelationship( (name: string, attr: AttributeDefinition): void ): void;
}
</code></pre>
<a class="header" href="0487-custom-model-classes.html#how-we-teach-this" id="how-we-teach-this"><h2>How we teach this</h2></a>
<p>This is a very addon/very power user specific api, and would be inappropriate for the default guides. We would document it in the Api docs and potentially if there was a guide for Ember Data addon developers.</p>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a rel="prev" href="0486-deprecate-mouseenter.html" class="mobile-nav-chapters previous">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="0491-deprecate-disconnect-outlet.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="0486-deprecate-mouseenter.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="0491-deprecate-disconnect-outlet.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>
    </body>
</html>
